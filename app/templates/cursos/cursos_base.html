{% extends "base.html" %}
{% from "cursos/_article.html" import article_navbar, section_header %}
{% from "_button_link.html" import button_link %}
{# Requires dict section_headers #}


{% block content_navbar %}
<nav id="article-navbar" class="navbar navbar-custom" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
        <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-center">
                {# <!-- Article sections --> #}
                {{article_navbar(section_headers)}}
            </ul>
        </div>
    </div>
</nav>
{% endblock content_navbar %}



{% block page_content %}

<!-- Article -->
{% block article %}{% endblock article %}


<!-- Quiz section header -->
{% if form and score != None and max_score != None %}
{{section_header("evaluacion", section_headers)}}
{% endif %}


<!-- Create quiz button -->


<style>
    #quizContainer {
        width: 100%;
        height: 50vh;
        border-radius: 20px;
        padding: 20px;
        background-color: #FFE1A4;
    }

    /* .quiz{
            text-align: center;
        } */

    .quiz .quiz-btn {
        display: flex;
        top: 50%;
    }

    @keyframes kf-fade-in {
        0% {
            opacity: 0;
        }

        100% {
            opacity: 1;
        }
    }

    .fade-in {
        animation-name: kf-fade-in;
        animation-duration: 1s;
    }
</style>
<div id="quizContainer" class="quiz">
    <button id="takeQuizBtn" class="btn quiz-btn">Hacer examen</button>
    <button id="dldCertBtn" class="btn quiz-btn">Descargar certificado</button>
</div>

{# 
    <!-- Commented out old quizzes -->
    <!-- Download certificate -->
    {% if already_passed == True and certificate_endpoint %}
        {{
            button_link(
                href=url_for("main.certificate", name=certificate_endpoint),
                btn_text="Descargar certificado",
                target="_blank"
            )
        }}
    {% endif %}

    <!-- Quiz -->
    {{quiz(form, score, max_score)}}

#}
{% endblock page_content %}

{% block scripts %}
{{super()}}
<script>

    const QUIZ = {
        topic: "{{topic}}",
        numQuestions: {{ num_questions }},
        dldCertUrl: "{{url_for('api.redirect_certificate') + '?topic=' + topic}}",
        fadeInClass: "fade-in",
        containerId: "quizContainer",
        containerElem: document.getElementById("quizContainer"),
        btnId: "takeQuizBtn",
        btnElem: document.getElementById("takeQuizBtn"),
        dldCertBtnId: "dldCertBtn",
        dldCertBtnElem: document.getElementById("dldCertBtn"),
    };

    const USER_EMAIL = "{{current_user.email}}";

    let USER_QUIZ_DATA = null
    getUserQuizData(USER_EMAIL).then((data)=>USER_QUIZ_DATA = data);
    while (USER_QUIZ_DATA === null){
        "string";
    }
    
    debugger;
    // Hide certificate button and add link to pdf
    QUIZ.dldCertBtnElem.style.display = "none";

    // Add event listener on click to fetch new quiz
    // Only works once
    QUIZ.btnElem.onclick = () => {
        renderNewQuiz(QUIZ.topic, QUIZ.numQuestions, QUIZ.containerElem, QUIZ.btnElem, QUIZ.fadeInClass, onClickSubmitBtn);
        QUIZ.btnElem.onclick = null;
    }


    // Fetches {answers, scroteToPass, htmlForm} from database
    function getNewQuiz(topic, numQuestions) {
        const endpoint = "{{url_for('api.get_quiz_html')}}" + "?topic=" + topic + "&num_questions=" + numQuestions;
        return new Promise((resolve, reject) => 
            $.ajax( {
                url: endpoint,
                type: "POST",
                success: (res) => resolve(res),
                error: (err) => reject(err),
            })
        );
    }

    function getUserQuizData(userEmail) {
        const endpoint = "{{url_for('api.get_user_quiz_data')}}" + "?email=" + userEmail;
        return new Promise((resolve,reject)=>
            $.ajax({
                url: endpoint,
                type: "GET",
                success: (res) => resolve(res),
                error: (err) => reject(err),
            })
        );
    }

    
    function passUserQuiz(userEmail, quizTopic) {
        const endpoint = "{{url_for('api.user_pass_quiz')}}" + "?topic=" + quizTopic + "&email=" + userEmail;
        return new Promise((resolve, reject) => 
            $.ajax({
                url: endpoint, 
                type: "POST",
                success: (resp) => resolve(resp),
                error: (err) => reject(err),
            })
        );
    }


    function onClickSubmitBtn(answers, scoreToPass, numQuestions, formElem){
        const score = calcQuizScore(answers, numQuestions, formElem);

        // TODO: remove debud if
        if (true || score >= scoreToPass){
            QUIZ.containerElem.querySelector("form").remove(); // Remove form
            //alert(`PASS ${score}/${scoreToPass}`); // TODO: Remove alert

            
            // Make the user pass the quiz and show the button
            passUserQuiz(USER_EMAIL, QUIZ.topic).then(
                (res) => {
                    debugger;
                    const dldCertBtnElem = document.getElementById(QUIZ.dldCertBtnId);
                    dldCertBtnElem.classList.add(QUIZ.fadeInClass);
                    dldCertBtnElem.style.display ="block";
                    dldCertBtnElem.onclick = () => window.open(QUIZ.dldCertUrl, "_blank");
                }
            );
            
        }
        else{
            alert(`no pass ${score}/${scoreToPass}`); // TODO: Remove alert

        }
    }

    
    function renderNewQuiz(topic, numQuestions, quizContainerElem, btnToHideElem, fadeInClass, onClickSubmitBtn) {
                
        const update = ({answers, scoreToPass, htmlForm}) => {
            
            console.log(answers);
            
            // Make button disappear
            btnToHideElem.style.display = "none";

            // Add quiz questions
            quizContainerElem.innerHTML += htmlForm;

            const quizFormElem = quizContainerElem.querySelector("form"); // Select new form
            quizFormElem.onsubmit = () => false; // Remove page refresh on submit
            quizFormElem.classList.add(fadeInClass); // Add fade in to form
            

            
            // Get the sumbit button
            const quizSubmitBtnElem = quizFormElem.querySelector("input#submit");
            quizSubmitBtnElem.onclick = () => onClickSubmitBtn(answers, scoreToPass, numQuestions, quizFormElem);


        };
        getNewQuiz(topic, numQuestions).then(update);
    }

    
    // Gets the user score on the quiz
    function calcQuizScore(correctAnswers, numQuestions, formElem, questionNameStr = "questions-%d-answer"){
        let score = 0;
        for (let i = 0; i < numQuestions; ++i) {
            const questionFieldName = questionNameStr.replace("%d", i);
            const userAnswer =  formElem[questionFieldName].value || null;
            if (userAnswer === correctAnswers[i]) {
                score++;
            }
        }
        return score;
    }

    










    // function updateUserQuizState() {
    //     // If use has passed quiz, display certificate button
    //     fetchUserQuizData(userEmail).then((userQuizData) => {
    //         console.log(userQuizData);
    //         if (userQuizData[quizTopic].is_passed === false) {
    //             dldCertBtnElem.style.display = "none"; // Hide the certificate button
    //             return;
    //         }

    //         // Add url to certificate button and show it
    //         dldCertBtnElem.onclick = () => window.open(dldCertUrl, "_blank");
    //         dldCertBtnElem.setAttribute("target", "_blank");
    //         dldCertBtnElem.style.display = "block";
    //     });
    // }

    // updateUserQuizState();

</script>
{% endblock scripts %}